<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생선수 훈련일지 생성기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
        }
        .calendar-day {
            transition: all 0.2s ease-in-out;
        }
        .calendar-day.selected {
            background-color: #3B82F6; /* blue-500 */
            color: white;
            border-radius: 50%;
        }
        .calendar-day:not(.disabled):hover {
            background-color: #BFDBFE; /* blue-200 */
            border-radius: 50%;
        }
        .day-name {
            font-weight: 600;
            color: #4B5563; /* gray-600 */
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 인쇄용 스타일 */
        @media print {
            body * {
                visibility: hidden;
            }
            #generated-log-content, #generated-log-content * {
                visibility: visible;
            }
            #generated-log-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .page-container {
                page-break-after: always;
                padding: 1.5cm;
                border: none !important;
                box-shadow: none !important;
                background-color: white !important;
            }
            .page-container:last-child {
                page-break-after: auto;
            }
            .approval-box { top: 0.5cm; right: 0.5cm; }
            .approval-box table, .approval-box th, .approval-box td {
                border: 1px solid black !important; padding: 0.25rem 0.5rem; font-size: 9pt;
            }
            .approval-box .approval-sign { height: 35px; }
            .log-title { font-size: 14pt !important; }
            .log-subtitle { font-size: 12pt !important; }
            #generated-log-content table, #generated-log-content th, #generated-log-content td {
                 border: 1px solid black !important;
                 -webkit-print-color-adjust: exact; 
                 print-color-adjust: exact;
            }
            #generated-log-content th { background-color: #F3F4F6 !important; }
            .cover-page { height: 98vh; }
        }

        /* 화면 표시용 스타일 */
        #generated-log-content {
            background-color: #f0f2f5;
            padding: 1.5rem;
            border-radius: 0.5rem;
        }
        .page-container {
            background-color: white;
            border: 1px solid #e0e0e0;
            padding: 2rem;
            margin: 0 auto 1.5rem auto;
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 210mm;
            min-height: 297mm;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        .approval-box {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }
        .approval-box table, .approval-box th, .approval-box td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 0.2rem 0.4rem;
            font-size: 0.7rem;
            text-align: center;
        }
        .approval-box .approval-sign { height: 30px; }
        .approval-box .approval-title {
            vertical-align: middle;
            line-height: 1.4;
        }
        .log-title {
            font-size: 1.75rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1rem;
        }
        .log-subtitle {
            font-size: 1.25rem;
            font-weight: 600;
            text-align: center;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }
        #generated-log-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
            border: 1px solid black;
        }
        #generated-log-content th, 
        #generated-log-content td {
            border: 1px solid black;
            padding: 0.75rem;
            text-align: center;
            font-size: 0.9rem;
            vertical-align: middle;
        }
        #generated-log-content th {
            background-color: #F3F4F6;
            font-weight: 600;
        }
        #generated-log-content td.content {
            text-align: left;
            white-space: pre-wrap;
        }
        
        /* 표지 스타일 */
        .cover-page .cover-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            text-align: center;
        }
        .cover-page .year {
            width: 100%;
            text-align: left;
            font-size: 1.25rem;
        }
        .cover-page .title-box {
            border: 4px solid black;
            padding: 1.5rem 3rem;
            margin: auto 0;
        }
        .cover-page .title-box h1 {
            font-size: 2.2rem;
            font-weight: bold;
            letter-spacing: 0.2em;
        }
        .cover-page .details {
            font-size: 1.5rem;
            line-height: 2.2;
        }
        .cover-page .school-name {
            font-size: 2rem;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">학생선수 훈련일지 생성기</h1>
            <p class="mt-2 text-md text-gray-600">필수 정보를 입력하고 간편하게 훈련 일지를 만들어보세요.</p>
        </header>

        <main class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            
            <div id="input-section">
                <h2 class="text-2xl font-semibold mb-6 pb-3 border-b-2 border-gray-200">1. 필수 정보 입력</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div class="space-y-4 p-4 border rounded-lg bg-gray-50">
                        <h3 class="font-semibold text-lg text-gray-700">기본 정보</h3>
                        <div>
                            <label for="teacherName" class="block text-sm font-medium text-gray-700 mb-1">담당 교사 이름</label>
                            <input type="text" id="teacherName" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="예: 홍길동">
                        </div>
                         <div>
                            <label for="schoolName" class="block text-sm font-medium text-gray-700 mb-1">학교 이름</label>
                            <input type="text" id="schoolName" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="예: 만승초등학교">
                        </div>
                        <div>
                            <label for="clubName" class="block text-sm font-medium text-gray-700 mb-1">부서 이름</label>
                            <input type="text" id="clubName" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="예: 태권도부">
                        </div>
                        <div>
                            <label for="trainingTime" class="block text-sm font-medium text-gray-700 mb-1">훈련 시간</label>
                            <input type="text" id="trainingTime" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="예: 14:40 ~ 16:50">
                        </div>
                    </div>

                    <div class="p-4 border rounded-lg bg-gray-50">
                         <h3 class="font-semibold text-lg text-gray-700">부원 명단</h3>
                        <div>
                            <label for="members" class="block text-sm font-medium text-gray-700 mb-1">전체 부원</label>
                            <textarea id="members" rows="8" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="학년/이름 형식, 한 줄에 한 명&#10;6/홍길동&#10;5/김철수"></textarea>
                        </div>
                    </div>

                    <div class="md:col-span-2 space-y-4 p-4 border rounded-lg bg-gray-50">
                        <h3 class="font-semibold text-lg text-gray-700">요일별 훈련 내용</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                            <textarea id="macro_mon" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="월요일 훈련 내용"></textarea>
                            <textarea id="macro_tue" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="화요일 훈련 내용"></textarea>
                            <textarea id="macro_wed" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="수요일 훈련 내용"></textarea>
                            <textarea id="macro_thu" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="목요일 훈련 내용"></textarea>
                            <textarea id="macro_fri" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="금요일 훈련 내용"></textarea>
                        </div>
                    </div>
                    
                    <div class="md:col-span-2 p-4 border rounded-lg bg-gray-50">
                        <h3 class="font-semibold text-lg text-gray-700 mb-2">훈련 날짜 선택</h3>
                        <div id="calendar-container" class="w-full max-w-3xl mx-auto">
                            <div class="flex items-center justify-between mb-4">
                                <button id="prev-month" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">&lt;</button>
                                <h2 id="calendar-title" class="text-xl font-semibold"></h2>
                                <button id="next-month" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">&gt;</button>
                            </div>
                             <div class="flex justify-center mb-4">
                                <button id="select-all-weekdays" class="w-full sm:w-auto bg-indigo-100 text-indigo-700 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-200">
                                    이번 달 평일 전체 선택
                                </button>
                            </div>
                            <div id="calendar-grid" class="grid grid-cols-8 gap-1 text-center"></div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 text-center">
                    <button id="generate-btn" class="w-full md:w-1/2 lg:w-1/3 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-transform transform hover:scale-105">
                        일지 생성하기
                    </button>
                </div>
            </div>

            <div id="result-section" class="mt-10 hidden">
                 <div id="loader-container" class="flex flex-col items-center justify-center hidden min-h-[200px]">
                    <div class="loader"></div>
                    <p class="mt-4 text-lg text-blue-600 font-semibold">일지를 생성하고 있습니다...</p>
                </div>
                <div id="log-output">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">생성된 일지 (클릭하여 수정 가능)</h2>
                        <div class="flex items-center gap-2">
                             <button id="pdf-download-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">PDF로 다운로드</button>
                             <button id="print-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">인쇄</button>
                        </div>
                    </div>
                    <div id="generated-log-content" contenteditable="true">
                    </div>
                </div>
            </div>
             <div id="message-box" class="hidden fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg z-50 transition-opacity duration-300"></div>
        </main>
    </div>

    <script>
        const { jsPDF } = window.jspdf;

        let currentDate = new Date();
        let selectedDates = new Set();
        const calendarGrid = document.getElementById('calendar-grid');
        const calendarTitle = document.getElementById('calendar-title');

        function generateCalendar(year, month) {
            calendarGrid.innerHTML = '';
            calendarTitle.textContent = `${year}년 ${month + 1}월`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay(); 

            const dayNames = ['주간선택', '일', '월', '화', '수', '목', '금', '토'];
            dayNames.forEach(day => {
                const dayNameEl = document.createElement('div');
                dayNameEl.className = 'day-name text-sm py-2';
                dayNameEl.textContent = day;
                calendarGrid.appendChild(dayNameEl);
            });
            
            let currentDay = 1;
            const numRows = Math.ceil((daysInMonth + startDayOfWeek) / 7);

            for (let row = 0; row < numRows; row++) {
                const buttonCell = document.createElement('div');
                buttonCell.className = 'flex items-center justify-center h-full';
                const button = document.createElement('button');
                button.textContent = '선택';
                button.className = 'text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200';
                button.dataset.rowIndex = row;
                button.onclick = (e) => { e.stopPropagation(); selectWeek(e.target); };
                buttonCell.appendChild(button);
                calendarGrid.appendChild(buttonCell);

                for (let col = 0; col < 7; col++) {
                    if (row === 0 && col < startDayOfWeek || currentDay > daysInMonth) {
                        calendarGrid.appendChild(document.createElement('div'));
                    } else {
                        const dayEl = document.createElement('div');
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(currentDay).padStart(2, '0')}`;
                        dayEl.textContent = currentDay;
                        dayEl.dataset.date = dateStr;
                        dayEl.className = 'calendar-day cursor-pointer flex items-center justify-center h-10';
                        
                        if (col === 0 || col === 6) dayEl.classList.add('text-red-500');
                        if (selectedDates.has(dateStr)) dayEl.classList.add('selected');
                        
                        dayEl.addEventListener('click', () => toggleDateSelection(dayEl));
                        calendarGrid.appendChild(dayEl);
                        currentDay++;
                    }
                }
            }
        }
        
        function selectWeek(button) {
            const rowIndex = parseInt(button.dataset.rowIndex, 10);
            const rowStartChildIndex = (rowIndex * 8) + 8;
            
            for (let i = 2; i <= 6; i++) {
                const dayCell = calendarGrid.children[rowStartChildIndex + i];
                if (dayCell && dayCell.dataset.date) {
                    const dateStr = dayCell.dataset.date;
                    if (!selectedDates.has(dateStr)) {
                        selectedDates.add(dateStr);
                        dayCell.classList.add('selected');
                    }
                }
            }
        }

        document.getElementById('select-all-weekdays').addEventListener('click', () => {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayOfWeek = date.getDay();
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    selectedDates.add(dateStr);
                }
            }
            generateCalendar(year, month);
        });

        function toggleDateSelection(dayEl) {
            const dateStr = dayEl.dataset.date;
            if (selectedDates.has(dateStr)) {
                selectedDates.delete(dateStr);
                dayEl.classList.remove('selected');
            } else {
                selectedDates.add(dateStr);
                dayEl.classList.add('selected');
            }
        }

        document.getElementById('prev-month').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
        });

        document.getElementById('next-month').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
        });

        function parseMembers(text) {
            return text.split('\n').filter(line => line.trim() !== '').map(line => {
                const parts = line.split('/');
                return { grade: parts[0]?.trim(), name: parts[1]?.trim() };
            });
        }
        
        document.getElementById('generate-btn').addEventListener('click', generateLog);

        function generateLog() {
            const teacherName = document.getElementById('teacherName').value;
            const schoolName = document.getElementById('schoolName').value;
            const clubName = document.getElementById('clubName').value;
            const members_text = document.getElementById('members').value;
            const trainingTime = document.getElementById('trainingTime').value;
            const macros = {
                1: document.getElementById('macro_mon').value, 2: document.getElementById('macro_tue').value,
                3: document.getElementById('macro_wed').value, 4: document.getElementById('macro_thu').value,
                5: document.getElementById('macro_fri').value,
            };

            if (!teacherName || !schoolName || !clubName || !members_text || !trainingTime || selectedDates.size === 0) {
                showMessage('모든 필수 정보를 입력해주세요.');
                return;
            }

            const members = parseMembers(members_text);
            const sortedDates = Array.from(selectedDates).sort();

            document.getElementById('result-section').classList.remove('hidden');
            document.getElementById('log-output').classList.add('hidden');
            document.getElementById('loader-container').classList.remove('hidden');

            const coverPageHtml = generateCoverPageHtml(new Date().getFullYear(), clubName, teacherName, schoolName);
            const trainingLogHtml = generateTrainingLogHtml(sortedDates, members, macros, trainingTime, clubName);
            
            document.getElementById('generated-log-content').innerHTML = coverPageHtml + trainingLogHtml;
            document.getElementById('loader-container').classList.add('hidden');
            document.getElementById('log-output').classList.remove('hidden');
        }
        
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }
        
        function generateCoverPageHtml(year, clubName, teacherName, schoolName) {
            return `
                <div class="page-container cover-page">
                    <div class="cover-content">
                        <p class="year">${year}학년도</p>
                        <div class="title-box">
                            <h1>학생 선수 훈련 일지</h1>
                        </div>
                        <div class="details">
                            <p>종목: ${clubName}</p>
                            <p>담당: ${teacherName}</p>
                        </div>
                        <p class="school-name">${schoolName}</p>
                    </div>
                </div>
            `;
        }

        function getApprovalBoxHtml() {
            return `
                <div class="approval-box">
                    <table>
                        <tr>
                            <th class="approval-title" rowspan="2">결<br>재</th>
                            <th>담당</th>
                            <th>교감</th>
                        </tr>
                        <tr>
                            <td class="approval-sign"></td>
                            <td class="approval-sign"></td>
                        </tr>
                    </table>
                </div>
            `;
        }

        function generateTrainingLogHtml(dates, members, macros, trainingTime, clubName) {
            if (dates.length === 0) return '';
            let html = '';
            const weeks = {};

            dates.forEach(dateStr => {
                const date = new Date(dateStr);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const week = getWeekNumber(date);
                const key = `${year}-${month}-${week}`;
                if (!weeks[key]) weeks[key] = { month: month, weekOfMonth: Math.ceil(date.getDate() / 7), dates: [] };
                weeks[key].dates.push(date);
            });

            for (const key in weeks) {
                const weekData = weeks[key];
                const month = weekData.month;
                const weekOfMonth = weekData.weekOfMonth;

                html += `<div class="page-container">`;
                html += getApprovalBoxHtml();
                html += `<h2 class="log-title">${new Date().getFullYear()}년 [${month}]월 ${clubName} 훈련 일지</h2>`;
                html += `<h3 class="log-subtitle">${month}월 ${weekOfMonth}주차</h3>`;
                
                html += `<table><thead><tr><th>활동일자</th><th>훈련내용</th><th>훈련시간</th><th>훈련인원</th></tr></thead><tbody>`;
                weekData.dates.forEach(date => {
                    const trainingContent = macros[date.getDay()] || '개인 훈련';
                    html += `<tr><td>${date.getMonth() + 1}.${date.getDate()}</td><td class="content">${trainingContent.replace(/\n/g, '<br>')}</td><td>${trainingTime}</td><td>${members.length}명</td></tr>`;
                });
                html += '</tbody></table>';

                html += `<h3 class="log-subtitle">출결 사항</h3>`;
                html += `<table><thead><tr><th>번호</th><th>학년</th><th>이름</th>`;
                weekData.dates.forEach(date => { html += `<th>${date.getMonth() + 1}.${date.getDate()}</th>`; });
                html += `<th>비고</th></tr></thead><tbody>`;
                
                members.forEach((member, index) => {
                    html += `<tr><td>${index + 1}</td><td>${member.grade}</td><td>${member.name}</td>${weekData.dates.map(() => `<td>Ο</td>`).join('')}<td></td></tr>`;
                });
                html += '</tbody></table></div>';
            }
            return html;
        }
        
        function showMessage(message) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => { messageBox.classList.add('hidden'); }, 3000);
        }

        document.getElementById('print-btn').addEventListener('click', () => { window.print(); });

        document.getElementById('pdf-download-btn').addEventListener('click', async () => {
            const btn = document.getElementById('pdf-download-btn');
            btn.textContent = 'PDF 생성 중...';
            btn.disabled = true;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const content = document.getElementById('generated-log-content');
            const pages = content.querySelectorAll('.page-container');
            
            try {
                for (let i = 0; i < pages.length; i++) {
                    const page = pages[i];
                    const canvas = await html2canvas(page, {
                        scale: 2,
                        useCORS: true,
                        logging: false
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    const imgProps = doc.getImageProperties(imgData);
                    const pdfWidth = doc.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    
                    if (i > 0) {
                        doc.addPage();
                    }
                    doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                }
                
                doc.save('학생선수_훈련일지.pdf');
                showMessage('PDF 파일이 성공적으로 다운로드되었습니다.');
            } catch (error) {
                console.error("PDF 생성 오류:", error);
                showMessage('PDF 생성 중 오류가 발생했습니다. 다시 시도해주세요.');
            } finally {
                btn.textContent = 'PDF로 다운로드';
                btn.disabled = false;
            }
        });

        window.onload = () => { generateCalendar(currentDate.getFullYear(), currentDate.getMonth()); };
    </script>
</body>
</html>
