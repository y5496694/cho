<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생선수 훈련/상담일지 생성기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
        }
        .tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .tab-btn.active {
            border-color: #3B82F6;
            color: #3B82F6;
            font-weight: 600;
        }
        .calendar-day {
            transition: all 0.2s ease-in-out;
        }
        .calendar-day.selected {
            background-color: #3B82F6;
            color: white;
            border-radius: 50%;
        }
        .calendar-day:not(.disabled):hover {
            background-color: #BFDBFE;
            border-radius: 50%;
        }
        .day-name {
            font-weight: 600;
            color: #4B5563;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media print {
            @page {
                size: A4;
                margin: 1.5cm;
            }
            body, html {
                background-color: white;
            }
            body * {
                visibility: hidden;
            }
            #generated-log-content, #generated-log-content * {
                visibility: visible;
            }
            #generated-log-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .page-container {
                page-break-after: always;
                border: none !important;
                box-shadow: none !important;
                background-color: white !important;
            }
            .page-container:last-child {
                page-break-after: auto;
            }
            .approval-box { top: 0.5cm; right: 0.5cm; }
            .approval-box table, .approval-box th, .approval-box td {
                border: 1px solid black !important; padding: 0.25rem 0.5rem; font-size: 9pt;
            }
            .approval-box .approval-sign { height: 35px; }
            .log-title { font-size: 14pt !important; }
            .log-subtitle { font-size: 12pt !important; }
            #generated-log-content table, #generated-log-content th, #generated-log-content td {
                 border: 1px solid black !important;
                 -webkit-print-color-adjust: exact; 
                 print-color-adjust: exact;
            }
            #generated-log-content th { background-color: #F3F4F6 !important; }
            .cover-page { height: 98vh; }
        }

        #generated-log-content {
            background-color: #f0f2f5;
            padding: 1.5rem;
            border-radius: 0.5rem;
        }
        .page-container {
            background-color: white;
            border: 1px solid #e0e0e0;
            padding: 2rem;
            margin: 0 auto 1.5rem auto;
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 210mm;
            min-height: 297mm;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        .approval-box {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }
        .approval-box table, .approval-box th, .approval-box td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 0.2rem 0.4rem;
            font-size: 0.7rem;
            text-align: center;
        }
        .approval-box .approval-sign { height: 30px; }
        .approval-box .approval-title {
            vertical-align: middle;
            line-height: 1.4;
        }
        .log-title {
            font-size: 1.75rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1rem;
        }
        .log-subtitle {
            font-size: 1.25rem;
            font-weight: 600;
            text-align: center;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }
        #generated-log-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
            border: 1px solid black;
        }
        #generated-log-content th, 
        #generated-log-content td {
            border: 1px solid black;
            padding: 0.75rem;
            text-align: center;
            font-size: 0.9rem;
            vertical-align: middle;
        }
        #generated-log-content th {
            background-color: #F3F4F6;
            font-weight: 600;
        }
        #generated-log-content td.content {
            text-align: left;
            white-space: pre-wrap;
        }
        
        .cover-page .cover-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            text-align: center;
        }
        .cover-page .year {
            width: 100%;
            text-align: left;
            font-size: 1.25rem;
        }
        .cover-page .title-box {
            border: 4px solid black;
            padding: 1.5rem 3rem;
            margin: auto 0;
        }
        .cover-page .title-box h1 {
            font-size: 2.2rem;
            font-weight: bold;
            letter-spacing: 0.2em;
        }
        .cover-page .details {
            font-size: 1.5rem;
            line-height: 2.2;
        }
        .cover-page .school-name {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .counseling-page .approval-box {
            position: static;
        }
        .counseling-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 1.5rem;
        }
        .counseling-header .log-title {
            flex-grow: 1;
            margin-bottom: 0;
        }
        .counseling-header .approval-box-wrapper {
            flex-shrink: 0;
            margin-left: 1rem;
        }

    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">학생선수 훈련/상담일지 생성기</h1>
            <p class="mt-2 text-md text-gray-600">아래 탭에서 원하는 일지 종류를 선택하여 생성하세요.</p>
        </header>

        <main class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="tab-training" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">훈련일지 생성</button>
                    <button id="tab-counseling" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-lg">상담일지 생성</button>
                </nav>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 mb-6">
                 <div class="space-y-4 p-4 border rounded-lg bg-gray-50">
                    <h3 class="font-semibold text-lg text-gray-700">기본 정보 (공통)</h3>
                    <div>
                        <label for="teacherName" class="block text-sm font-medium text-gray-700 mb-1">담당 교사 이름</label>
                        <input type="text" id="teacherName" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="예: 홍길동">
                    </div>
                     <div>
                        <label for="schoolName" class="block text-sm font-medium text-gray-700 mb-1">학교 이름</label>
                        <input type="text" id="schoolName" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="예: 만승초등학교">
                    </div>
                    <div>
                        <label for="clubName" class="block text-sm font-medium text-gray-700 mb-1">부서 이름</label>
                        <input type="text" id="clubName" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="예: 태권도부">
                    </div>
                </div>
                <div id="members-input-section" class="p-4 border rounded-lg bg-gray-50">
                     <h3 class="font-semibold text-lg text-gray-700">부원 명단 (훈련일지용)</h3>
                    <div>
                        <label for="members" class="block text-sm font-medium text-gray-700 mb-1">전체 부원</label>
                        <textarea id="members" rows="8" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="학년/이름 형식, 한 줄에 한 명&#10;6/홍길동&#10;5/김철수"></textarea>
                    </div>
                </div>
            </div>

            <div id="training-log-panel">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div class="md:col-span-2 space-y-4 p-4 border rounded-lg bg-gray-50">
                        <h3 class="font-semibold text-lg text-gray-700">훈련 시간</h3>
                        <input type="text" id="trainingTime" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="예: 14:40 ~ 16:50">
                    </div>

                    <div id="daily-macros-section" class="md:col-span-2 space-y-4 p-4 border rounded-lg bg-gray-50">
                        <h3 class="font-semibold text-lg text-gray-700">요일별 훈련 내용</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                            <textarea id="macro_mon" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="월요일 훈련 내용"></textarea>
                            <textarea id="macro_tue" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="화요일 훈련 내용"></textarea>
                            <textarea id="macro_wed" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="수요일 훈련 내용"></textarea>
                            <textarea id="macro_thu" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="목요일 훈련 내용"></textarea>
                            <textarea id="macro_fri" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="금요일 훈련 내용"></textarea>
                        </div>
                    </div>

                    <div class="md:col-span-2 p-4 border rounded-lg bg-gray-50">
                        <div class="flex items-center">
                            <input id="ai-training-checkbox" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="ai-training-checkbox" class="ml-2 block text-lg font-semibold text-gray-800">AI 훈련 내용 생성</label>
                        </div>
                    </div>

                    <div id="ai-training-input-section" class="md:col-span-2 p-4 border rounded-lg bg-gray-50 hidden">
                        <h3 class="font-semibold text-lg text-gray-700">AI 훈련 내용 생성용 활동 목록</h3>
                        <p class="text-sm text-gray-500 mb-2">AI가 조합할 전체 훈련 활동을 쉼표(,)로 구분하여 입력해주세요.</p>
                        <textarea id="ai-training-input" rows="5" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="예시: 준비운동, 지그재그발차기, 받아차기, 이중발차기, 앞발커트..."></textarea>
                    </div>
                    
                    <div class="md:col-span-2 p-4 border rounded-lg bg-gray-50">
                        <h3 class="font-semibold text-lg text-gray-700 mb-2">훈련 날짜 선택</h3>
                        <div id="calendar-container" class="w-full max-w-3xl mx-auto">
                            <div class="flex items-center justify-between mb-4">
                                <button id="prev-month" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">&lt;</button>
                                <h2 id="calendar-title" class="text-xl font-semibold"></h2>
                                <button id="next-month" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">&gt;</button>
                            </div>
                             <div class="flex justify-center mb-4">
                                <button id="select-all-weekdays" class="w-full sm:w-auto bg-indigo-100 text-indigo-700 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-200">
                                    이번 달 평일 전체 선택
                                </button>
                            </div>
                            <div id="calendar-grid" class="grid grid-cols-8 gap-1 text-center"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="counseling-log-panel" class="hidden">
                 <div class="p-4 border rounded-lg bg-gray-50">
                    <h3 class="font-semibold text-lg text-gray-700 mb-2">상담 내용 입력</h3>
                    <p class="text-sm text-gray-500 mb-4">상담내용에 키워드/주제만 작성하고 '문장 생성'을 누르면 AI가 자연스러운 문장으로 만들어줍니다.</p>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th class="px-2 py-2">순번</th>
                                    <th class="px-2 py-2">상담일자 (MM/DD)</th>
                                    <th class="px-2 py-2">학년</th>
                                    <th class="px-2 py-2">이름</th>
                                    <th class="px-2 py-2 w-2/5">상담내용 (키워드/주제)</th>
                                    <th class="px-2 py-2">상담자</th>
                                    <th class="px-2 py-2"></th>
                                </tr>
                            </thead>
                            <tbody id="counseling-input-tbody">
                            </tbody>
                        </table>
                    </div>
                    <button id="add-counseling-row-btn" class="mt-4 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">+ 추가</button>
                </div>
            </div>

            <div class="mt-8 text-center">
                <button id="generate-btn" class="w-full md:w-1/2 lg:w-1/3 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-transform transform hover:scale-105">
                    일지 생성하기
                </button>
            </div>

            <div id="result-section" class="mt-10 hidden">
                 <div id="loader-container" class="flex flex-col items-center justify-center hidden min-h-[200px]">
                    <div class="loader"></div>
                    <p class="mt-4 text-lg text-blue-600 font-semibold">일지를 생성하고 있습니다...</p>
                </div>
                <div id="log-output">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">생성된 일지 (클릭하여 수정 가능)</h2>
                        <div class="flex items-center gap-2">
                             <button id="pdf-download-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">PDF로 다운로드</button>
                             <button id="print-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">인쇄</button>
                        </div>
                    </div>
                    <div id="generated-log-content" contenteditable="true">
                    </div>
                </div>
            </div>
             <div id="message-box" class="hidden fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg z-50 transition-opacity duration-300"></div>
        </main>
    </div>

    <script>
        const { jsPDF } = window.jspdf;

        let currentDate = new Date();
        let selectedDates = new Set();
        const calendarGrid = document.getElementById('calendar-grid');
        const calendarTitle = document.getElementById('calendar-title');

        function generateCalendar(year, month) {
            calendarGrid.innerHTML = '';
            calendarTitle.textContent = `${year}년 ${month + 1}월`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay(); 

            const dayNames = ['주간선택', '일', '월', '화', '수', '목', '금', '토'];
            dayNames.forEach(day => {
                const dayNameEl = document.createElement('div');
                dayNameEl.className = 'day-name text-sm py-2';
                dayNameEl.textContent = day;
                calendarGrid.appendChild(dayNameEl);
            });
            
            let currentDay = 1;
            const numRows = Math.ceil((daysInMonth + startDayOfWeek) / 7);

            for (let row = 0; row < numRows; row++) {
                const buttonCell = document.createElement('div');
                buttonCell.className = 'flex items-center justify-center h-full';
                const button = document.createElement('button');
                button.textContent = '선택';
                button.className = 'text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200';
                button.dataset.rowIndex = row;
                button.onclick = (e) => { e.stopPropagation(); selectWeek(e.target); };
                buttonCell.appendChild(button);
                calendarGrid.appendChild(buttonCell);

                for (let col = 0; col < 7; col++) {
                    if (row === 0 && col < startDayOfWeek || currentDay > daysInMonth) {
                        calendarGrid.appendChild(document.createElement('div'));
                    } else {
                        const dayEl = document.createElement('div');
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(currentDay).padStart(2, '0')}`;
                        dayEl.textContent = currentDay;
                        dayEl.dataset.date = dateStr;
                        dayEl.className = 'calendar-day cursor-pointer flex items-center justify-center h-10';
                        
                        if (col === 0 || col === 6) dayEl.classList.add('text-red-500');
                        if (selectedDates.has(dateStr)) dayEl.classList.add('selected');
                        
                        dayEl.addEventListener('click', () => toggleDateSelection(dayEl));
                        calendarGrid.appendChild(dayEl);
                        currentDay++;
                    }
                }
            }
        }
        
        function selectWeek(button) {
            const rowIndex = parseInt(button.dataset.rowIndex, 10);
            const rowStartChildIndex = (rowIndex * 8) + 8;
            
            for (let i = 2; i <= 6; i++) {
                const dayCell = calendarGrid.children[rowStartChildIndex + i];
                if (dayCell && dayCell.dataset.date) {
                    const dateStr = dayCell.dataset.date;
                    if (!selectedDates.has(dateStr)) {
                        selectedDates.add(dateStr);
                        dayCell.classList.add('selected');
                    }
                }
            }
        }

        document.getElementById('select-all-weekdays').addEventListener('click', () => {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayOfWeek = date.getDay();
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    selectedDates.add(dateStr);
                }
            }
            generateCalendar(year, month);
        });

        function toggleDateSelection(dayEl) {
            const dateStr = dayEl.dataset.date;
            if (selectedDates.has(dateStr)) {
                selectedDates.delete(dateStr);
                dayEl.classList.remove('selected');
            } else {
                selectedDates.add(dateStr);
                dayEl.classList.add('selected');
            }
        }

        document.getElementById('prev-month').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
        });

        document.getElementById('next-month').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
        });

        function parseMembers(text) {
            return text.split('\n').filter(line => line.trim() !== '').map(line => {
                const parts = line.split('/');
                return { grade: parts[0]?.trim(), name: parts[1]?.trim() };
            });
        }
        
        document.getElementById('generate-btn').addEventListener('click', async () => {
            const activeTab = document.querySelector('.tab-btn.active').id;
            
            document.getElementById('result-section').classList.remove('hidden');
            document.getElementById('log-output').classList.add('hidden');
            document.getElementById('loader-container').classList.remove('hidden');

            try {
                if (activeTab === 'tab-training') {
                    await generateTrainingLog();
                } else {
                    await generateCounselingLog();
                }
            } catch (error) {
                 console.error('Error generating log:', error);
                showMessage('일지 생성 중 오류가 발생했습니다: ' + error.message);
            } finally {
                document.getElementById('loader-container').classList.add('hidden');
                document.getElementById('log-output').classList.remove('hidden');
            }
        });

        async function generateTrainingLog() {
            const teacherName = document.getElementById('teacherName').value;
            const schoolName = document.getElementById('schoolName').value;
            const clubName = document.getElementById('clubName').value;
            const members_text = document.getElementById('members').value;
            const trainingTime = document.getElementById('trainingTime').value;
            const useAiTraining = document.getElementById('ai-training-checkbox').checked;

            if (!teacherName || !schoolName || !clubName || !members_text || !trainingTime || selectedDates.size === 0) {
                showMessage('훈련일지 생성을 위한 모든 필수 정보를 입력해주세요.');
                throw new Error('Incomplete training log data.');
            }

            let macros = null;
            let allActivities = null;

            if (useAiTraining) {
                const aiTrainingInput = document.getElementById('ai-training-input').value;
                if (!aiTrainingInput) {
                    showMessage('AI 훈련 내용 생성을 체크한 경우, 활동 목록을 반드시 입력해야 합니다.');
                    throw new Error('Missing AI training activities.');
                }
                allActivities = aiTrainingInput.split(',').map(item => item.trim()).filter(item => item);
            } else {
                macros = {
                    1: document.getElementById('macro_mon').value, 2: document.getElementById('macro_tue').value,
                    3: document.getElementById('macro_wed').value, 4: document.getElementById('macro_thu').value,
                    5: document.getElementById('macro_fri').value,
                };
            }

            const members = parseMembers(members_text);
            const sortedDates = Array.from(selectedDates).sort();

            const coverPageHtml = generateCoverPageHtml(new Date().getFullYear(), clubName, teacherName, schoolName, "학생 선수 훈련/상담 일지");
            const trainingLogHtml = generateTrainingLogHtml(sortedDates, members, macros, trainingTime, clubName, useAiTraining, allActivities);
            
            document.getElementById('generated-log-content').innerHTML = coverPageHtml + trainingLogHtml;
        }

        async function generateCounselingLog() {
            const teacherName = document.getElementById('teacherName').value;
            const schoolName = document.getElementById('schoolName').value;
            const clubName = document.getElementById('clubName').value;
            if (!teacherName || !schoolName || !clubName) {
                 showMessage('상담일지 생성을 위해 기본 정보(담당교사, 학교, 부서)를 입력해주세요.');
                 throw new Error('Incomplete basic info for counseling log.');
            }
            const counselingLogHtml = await buildCounselingPagesHtml();
            document.getElementById('generated-log-content').innerHTML = counselingLogHtml;
        }
        
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }
        
        function generateCoverPageHtml(year, clubName, teacherName, schoolName, title) {
            return `
                <div class="page-container cover-page">
                    <div class="cover-content">
                        <p class="year">${year}학년도</p>
                        <div class="title-box">
                            <h1>${title}</h1>
                        </div>
                        <div class="details">
                            <p>종목: ${clubName}</p>
                            <p>담당: ${teacherName}</p>
                        </div>
                        <p class="school-name">${schoolName}</p>
                    </div>
                </div>
            `;
        }

        function getApprovalBoxHtml() {
            return `
                <div class="approval-box">
                    <table>
                        <tr>
                            <th class="approval-title" rowspan="2">결<br>재</th>
                            <th>담당</th>
                            <th>교감</th>
                        </tr>
                        <tr>
                            <td class="approval-sign"></td>
                            <td class="approval-sign"></td>
                        </tr>
                    </table>
                </div>
            `;
        }
        
        function generateRandomTrainingContent(activities) {
            const shuffled = [...activities].sort(() => 0.5 - Math.random());
            const count = Math.floor(Math.random() * 3) + 5; // 5 to 7 activities
            return shuffled.slice(0, count).join(', ');
        }

        function generateTrainingLogHtml(dates, members, macros, trainingTime, clubName, useAiTraining, allActivities) {
            if (dates.length === 0) return '';
            let html = '';
            const weeks = {};

            dates.forEach(dateStr => {
                const date = new Date(dateStr);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const week = getWeekNumber(date);
                const key = `${year}-${month}-${week}`;
                if (!weeks[key]) weeks[key] = { month: month, weekOfMonth: Math.ceil(date.getDate() / 7), dates: [] };
                weeks[key].dates.push(date);
            });

            for (const key in weeks) {
                const weekData = weeks[key];
                const month = weekData.month;
                const weekOfMonth = weekData.weekOfMonth;

                html += `<div class="page-container">`;
                html += getApprovalBoxHtml();
                html += `<h2 class="log-title">${new Date().getFullYear()}년 [${month}]월 ${clubName} 훈련 일지</h2>`;
                html += `<h3 class="log-subtitle">${month}월 ${weekOfMonth}주차</h3>`;
                
                html += `<table><thead><tr><th>활동일자</th><th>훈련내용</th><th>훈련시간</th><th>훈련인원</th></tr></thead><tbody>`;
                weekData.dates.forEach(date => {
                    let trainingContent = '';
                    if (useAiTraining) {
                        trainingContent = generateRandomTrainingContent(allActivities);
                    } else {
                        trainingContent = macros[date.getDay()] || '개인 훈련';
                    }
                    html += `<tr><td>${date.getMonth() + 1}.${date.getDate()}</td><td class="content">${trainingContent.replace(/\n/g, '<br>')}</td><td>${trainingTime}</td><td>${members.length}명</td></tr>`;
                });
                html += '</tbody></table>';

                html += `<h3 class="log-subtitle">출결 사항</h3>`;
                html += `<table><thead><tr><th>번호</th><th>학년</th><th>이름</th>`;
                weekData.dates.forEach(date => { html += `<th>${date.getMonth() + 1}.${date.getDate()}</th>`; });
                html += `<th>비고</th></tr></thead><tbody>`;
                
                members.forEach((member, index) => {
                    html += `<tr><td>${index + 1}</td><td>${member.grade}</td><td>${member.name}</td>${weekData.dates.map(() => `<td>Ο</td>`).join('')}<td></td></tr>`;
                });
                html += '</tbody></table></div>';
            }
            return html;
        }
        
        document.getElementById('ai-training-checkbox').addEventListener('change', (e) => {
            const dailySection = document.getElementById('daily-macros-section');
            const aiSection = document.getElementById('ai-training-input-section');
            if (e.target.checked) {
                dailySection.classList.add('hidden');
                aiSection.classList.remove('hidden');
            } else {
                dailySection.classList.remove('hidden');
                aiSection.classList.add('hidden');
            }
        });

        document.getElementById('add-counseling-row-btn').addEventListener('click', addCounselingRow);
        
        let counselingRowCount = 0;
        function addCounselingRow() {
            counselingRowCount++;
            const tbody = document.getElementById('counseling-input-tbody');
            const newRow = document.createElement('tr');
            newRow.className = 'bg-white border-b';
            newRow.innerHTML = `
                <td class="px-2 py-2 font-medium text-gray-900">${counselingRowCount}</td>
                <td class="px-2 py-2"><input type="text" class="counseling-date w-full border rounded p-1" placeholder="MM/DD"></td>
                <td class="px-2 py-2"><input type="text" class="counseling-grade w-12 border rounded p-1" placeholder="6"></td>
                <td class="px-2 py-2"><input type="text" class="counseling-name w-full border rounded p-1"></td>
                <td class="px-2 py-2"><textarea class="counseling-content w-full border rounded p-1" rows="2" placeholder="키워드 입력 후 문장 생성"></textarea></td>
                <td class="px-2 py-2"><input type="text" class="counseling-counselor w-full border rounded p-1" placeholder="담당교사"></td>
                <td class="px-2 py-2"><button type="button" class="generate-sentence-btn bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded hover:bg-blue-200">문장 생성</button></td>
            `;
            tbody.appendChild(newRow);
        }

        document.getElementById('counseling-input-tbody').addEventListener('click', async (e) => {
            if (e.target && e.target.classList.contains('generate-sentence-btn')) {
                const btn = e.target;
                const row = btn.closest('tr');
                const contentTextarea = row.querySelector('.counseling-content');
                const studentNameInput = row.querySelector('.counseling-name');
                const keyword = contentTextarea.value;
                const studentName = studentNameInput.value || '해당 학생은';

                if (!keyword) {
                    showMessage('상담내용 키워드를 먼저 입력해주세요.');
                    return;
                }

                btn.textContent = '생성중...';
                btn.disabled = true;

                try {
                    const clubName = document.getElementById('clubName').value;
                    const prompt = `당신은 초등학교 교사입니다. 다음 정보를 바탕으로 학생선수 상담일지에 들어갈 한 문단 분량의 구체적인 상담 내용을 작성해주세요. 문장의 끝은 반드시 '함.', '임.', '하였음.'과 같이 'ㅁ' 받침으로 끝나야 합니다. 전체 내용을 한 개의 자연스러운 문단으로 요약하여 작성해야 합니다.
                    
[정보]
- 학생 이름: ${studentName}
- 부서명: ${clubName}
- 상담 키워드: "${keyword}"

[작성 예시]
키워드: "체력 저하 고민"
생성 예시: "최근 체력 훈련 시 힘들어하는 모습을 자주 보임. 특히 후반부에 집중력이 떨어지고 동작이 무뎌지는 경향이 있어, 체력적인 부담에 대해 이야기를 나눔. 꾸준한 기초 체력 훈련의 중요성을 강조하고, 무리하지 않는 선에서 점진적으로 훈련 강도를 높여갈 수 있도록 격려함."

[요청]
위 정보를 바탕으로 상담 내용을 생성해주세요.`;
                    
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = "AIzaSyC7_Gq4LIVVMv0hMD6qSwcTlGJcDSt-KgI";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API call failed: ${response.statusText}`);
                    
                    const result = await response.json();
                    const generatedText = result.candidates[0].content.parts[0].text;
                    contentTextarea.value = generatedText;

                } catch (error) {
                    console.error("Sentence generation error:", error);
                    showMessage("문장 생성에 실패했습니다.");
                } finally {
                    btn.textContent = '문장 생성';
                    btn.disabled = false;
                }
            }
        });

        async function buildCounselingPagesHtml() {
            const rows = document.querySelectorAll('#counseling-input-tbody tr');
            if (rows.length === 0) return '';
            
            const data = [];
            rows.forEach(row => {
                const content = row.querySelector('.counseling-content').value;
                if (content) {
                    data.push({
                        date: row.querySelector('.counseling-date').value || '1/1',
                        grade: row.querySelector('.counseling-grade').value || '6',
                        name: row.querySelector('.counseling-name').value || '홍길동',
                        content: content,
                        counselor: row.querySelector('.counseling-counselor').value || '담당교사(담임)'
                    });
                }
            });

            if (data.length === 0) {
                showMessage('상담일지를 생성하려면 최소 한 개 이상의 상담내용을 입력해주세요.');
                throw new Error('No counseling log data to generate.');
            }

            let html = '';
            const ROWS_PER_PAGE = 5;
            const numPages = Math.ceil(data.length / ROWS_PER_PAGE);
            const clubName = document.getElementById('clubName').value;
            const teacherName = document.getElementById('teacherName').value;
            const schoolName = document.getElementById('schoolName').value;
            
            html += generateCoverPageHtml(new Date().getFullYear(), clubName, teacherName, schoolName, "학생 선수 상담 일지");

            for (let i = 0; i < numPages; i++) {
                const pageData = data.slice(i * ROWS_PER_PAGE, (i + 1) * ROWS_PER_PAGE);
                
                html += `<div class="page-container counseling-page">`;
                html += `
                    <div class="counseling-header">
                        <h2 class="log-title">${new Date().getFullYear()}년 ${clubName} 학생선수 상담 일지</h2>
                        <div class="approval-box-wrapper">
                            ${getApprovalBoxHtml()}
                        </div>
                    </div>
                `;
                html += `<table><thead><tr><th>순번</th><th>상담일자</th><th>학년/반</th><th>이름</th><th>상담내용</th><th>상담자</th></tr></thead><tbody>`;
                pageData.forEach((item, index) => {
                    html += `<tr><td>${(i * ROWS_PER_PAGE) + index + 1}</td><td>${item.date}</td><td>${item.grade}</td><td>${item.name}</td><td class="content">${item.content}</td><td>${item.counselor}</td></tr>`;
                });
                html += '</tbody></table></div>';
            }
            return html;
        }

        function showMessage(message) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => { messageBox.classList.add('hidden'); }, 3000);
        }

        document.getElementById('print-btn').addEventListener('click', () => { window.print(); });

        document.getElementById('pdf-download-btn').addEventListener('click', async () => {
            const btn = document.getElementById('pdf-download-btn');
            btn.textContent = 'PDF 생성 중...';
            btn.disabled = true;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const content = document.getElementById('generated-log-content');
            const pages = content.querySelectorAll('.page-container');
            
            try {
                for (let i = 0; i < pages.length; i++) {
                    const page = pages[i];
                    const canvas = await html2canvas(page, {
                        scale: 2,
                        useCORS: true,
                        logging: false
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    const imgProps = doc.getImageProperties(imgData);
                    const pdfWidth = doc.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    
                    if (i > 0) {
                        doc.addPage();
                    }
                    doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                }
                
                doc.save('학생선수_일지.pdf');
                showMessage('PDF 파일이 성공적으로 다운로드되었습니다.');
            } catch (error) {
                console.error("PDF 생성 오류:", error);
                showMessage('PDF 생성 중 오류가 발생했습니다. 다시 시도해주세요.');
            } finally {
                btn.textContent = 'PDF로 다운로드';
                btn.disabled = false;
            }
        });
        
        const tabTraining = document.getElementById('tab-training');
        const tabCounseling = document.getElementById('tab-counseling');
        const trainingPanel = document.getElementById('training-log-panel');
        const counselingPanel = document.getElementById('counseling-log-panel');
        const membersInputSection = document.getElementById('members-input-section');

        tabTraining.addEventListener('click', () => {
            tabTraining.classList.add('active');
            tabCounseling.classList.remove('active');
            trainingPanel.classList.remove('hidden');
            counselingPanel.classList.add('hidden');
            membersInputSection.classList.remove('hidden');
        });

        tabCounseling.addEventListener('click', () => {
            tabCounseling.classList.add('active');
            tabTraining.classList.remove('active');
            counselingPanel.classList.remove('hidden');
            trainingPanel.classList.add('hidden');
            membersInputSection.classList.add('hidden');
            if (document.getElementById('counseling-input-tbody').children.length === 0) {
                addCounselingRow();
            }
        });

        window.onload = () => { generateCalendar(currentDate.getFullYear(), currentDate.getMonth()); };
    </script>
</body>
</html>
